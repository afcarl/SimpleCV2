box: nuzz/box-SimpleCV2
build:
  steps:
    - script:
        name: git source key stuff
        code: |
          echo $SOURCE_KEY | base64 --decode > ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval `ssh-agent` > /dev/null 2>&1
          ssh-add ~/.ssh/id_rsa > /dev/null 2>&1
    - script:
        name: setup SimpleCV2 on Wercker
        code: |
          sudo python setup.py develop
    - script:
        name: run tests
        code: |
          nosetests -w simplecv/tests -v --with-coverage
  after-steps:
    - script:
        name: Coveralls.io
        code: |
          export CIRCLE_BRANCH=$WERCKER_GIT_BRANCH
          coveralls
deploy:
  steps:
    - add-to-known_hosts:
        hostname: $DO_BOX
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $SIMPLECV2_PRIVATE
        overwrite: true
    - script:
        name: transfer SimpleCV2 module
        code: |
          rsync -ai --exclude '*.egg-info' --delete -e "ssh -i $PRIVATEKEY_PATH" $WERCKER_SOURCE_DIR/ sm@$DO_BOX:~/Code/SimpleCV2/
    - script:
        name: setup SimpleCV2 on DigitalOcean
        code: ssh -i $PRIVATEKEY_PATH -l sm $DO_BOX "cd ~/Code/qa && ./setup_and_build_ci_box.sh"
  after-steps:
    - hipchat-notify:
        token: $HIPCHAT_TOKEN
        room-id: 362330
        from-name: wercker
